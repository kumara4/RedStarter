<!DOCTYPE html>
<!--
Authors: Ashmita Kumar and Henry Lopez
Landing: Page that user sees after user logs in or signed up.
User can begin getting subreddit recommendations, by connecting to Facebook or searching.

-->
<html xmlns:xlink="http://www.w3.org/1999/xlink">
<head>
    <!-- Jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.0.0-rc2/css/bootstrap.css" rel="stylesheet"
          media="screen">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
            integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
            crossorigin="anonymous"></script>

    <script src="https://use.fontawesome.com/1fb77ba1d7.js"></script>

    <!--Firebase-->
    <script src="https://www.gstatic.com/firebasejs/3.4.0/firebase.js"></script>
    <!--React -->
    <script src="https://unpkg.com/react@15.3.2/dist/react.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.js"></script>
    <script src="https://unpkg.com/babel-core@5.8.38/browser.min.js"></script>
    <script src="https://unpkg.com/react@15.3.2/dist/react-with-addons.min.js"></script>
    <script src="https://unpkg.com/react-dom@15.3.2/dist/react-dom.min.js"></script>


    <script src="//d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript"></script>

    <!--JASMINE-->
    <!--<script type="text/javascript" src="jasmine/lib/jasmine-2.5.2/jasmine.js"></script>-->
    <!--<script type="text/javascript" src="jasmine/lib/jasmine-2.5.2/jasmine-html.js"></script>-->
    <!--<script type="text/javascript" src="jasmine/lib/jasmine-2.5.2/boot.js"></script>-->
    <!--<link rel="stylesheet" type="text/css" href="jasmine/lib/jasmine-2.5.2/jasmine.css">-->

    <!--<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>-->
    <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/respond.js/1.2.0/respond.js"></script>
    <!-- React -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.2/react-with-addons.js"></script>
    <script src="https://fb.me/react-dom-15.0.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <!-- ReactFire -->
    <script src="https://cdn.firebase.com/libs/reactfire/1.0.0/reactfire.min.js"></script>

    <link rel="stylesheet" type="text/css" href="css/normalize.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <link rel="stylesheet" type="text/css" href="css/landing.css">
    <script type="text" src="js/landing.js"></script>
    <script type="text/babel" src="js/landing2.js"></script>


    <title>RedStarter</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<div id="mainpage">

</div>


<script type="text/babel">
<<<<<<< HEAD
    //    function deleteItem(divElem) {
    //        divElem.parentElement.removeChild(divElem);
    //    }
    //    if($("#searchresults").children.length <=2){
    //
    //    }
    "use strict";

    var count = 1;
    var totalsearchitems = 0;
    var counter = 0;
    var data = [];
    var formdata = [];
    var l = 0;

    var donedata = {"name": "flare", "children": []};
    var circledata = {"name": "flare", "children": []};

    var LandingPage = React.createClass({
        getInitialState: function () {
            return {id: ++l};
        },
        render: function () {

            return (
                    <div key={++count} className="landingpage">
                        <div className="alien_img">
                            <img src="img/alien.png"/>
                        </div>
                        <SearchBox />

                        <TopicBox />
                    </div>
            );
        }
    });


    var SearchBox = React.createClass({
        getInitialState: function () {
            return {results: [], text: '', id: ++count, terms: []};
        },
        componentDidMount: function (e) {

            ReactDOM.findDOMNode(this.refs.searchInput).focus();
            this.refreshLoadedData(this.state.terms);

        },
        onChange: function (e) {

            e.preventDefault();
            this.setState({text: e.target.value});
        },


        deleteTerm: function (term) {
            var items = this.state.terms.filter(function (el) {
                return term.id !== el.id;
            });
            totalsearchitems--;
            this.setState({
                terms: items
            });
        },


        refreshLoadedData: function (terms) {
            if (terms.length > 0) {
                data = [];
                var num = 50 / totalsearchitems;

                counter = 0;
                terms.map(function (term) {
                    counter++;
                    $.ajax({
                        url: "https://www.reddit.com/subreddits/search/.json?q=" + term.text + "&sort=relevance&limit=" + num.toString(),
                        dataType: 'json',
                        cache: false,
                        success: function (output) {
                            $.each(output.data.children, function (ii, item) {

                                var sub = {
                                    sub: item.data.subscribers,
                                    url: item.data.url,
                                    display_name: item.data.display_name,
                                    id: item.data.id
                                };

                                data.push(sub);

                            });
                            if (counter == terms.length) {
                                var temp = data;
                                this.work(temp);
                            }

                            this.setState({results: data});

                        }.bind(this),
                        error: function (xhr, status, err) {
                            console.error(this.props.url, status, err.toString());
                        }.bind(this)
                    });

                }, this);

            } else {
                document.getElementById("circle").innerHTML = "";
            }
        },
        work: function (data) {
            var items = {};
            circledata = {"name": "flare", "children": []};
            var items2 = {"name": "nametemp", "children": [{"name2": "nametemp2", "children": []}]};

            data.forEach(function (item) {
                var chi = {"name": item.display_name, "url": item.url, "size": item.sub};
                items2.children[0].children.push(chi);
            });


            circledata.children.push(items2);

            createCirclemap();

        },
        searchTerms: function () {
            data = [];

            this.refreshLoadedData(this.state.terms);


        },
        handleNewWord: function (e) {
            e.preventDefault(); // This is, by default, submit button by form. Make sure it isn't submitted.
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            if (keyCode == '13' && this.value != "") {
                totalsearchitems += 1;

                var nextTerms = this.state.terms.concat([{text: this.state.text, id: ++count}]);
                var nextText = '';
                this.setState({terms: nextTerms, text: nextText});

            }

        },
        render: function () {
            return (

                    <section className="jumbotron text-center button_search center ">


                        <div className="row">
                            <div className="connecttofacebook">
                                <button className="facebookbutton">
                                    Connect with Facebook
                                </button>
                            </div>

                            <h3> Or enter a list of your interests to get recommended subreddits!</h3>

                            <div key={this.props.id} id="interest_list" className="searchBox interest_list">
                                <label>I like</label>
                                <input type="text" ref="searchInput" onChange={this.onChange}
                                       onKeyUp={this.handleNewWord}
                                       value={this.state.text} id="searchterms" placeholder=" dogs"/>
                                <p>Press enter to add term</p>

                                <SearchList terms={this.state.terms} deleteTerm={this.deleteTerm}/>


                                <button onClick={this.searchTerms} id="searchnow">Search for Subreddits</button>

                                <div id="circle"></div>
                                <ResultList results={this.state.results}/>


                            </div>
                        </div>
                    </section>
            )
                    ;
        }

    });

    var ResultList = React.createClass({
        render: function () {

            return (
                    <div key={++count} id="searchresults" className="searchresults">
                        {this.props.results.map(function (result) {
                            return (

                                    <Result key={result.id} display_name={result.display_name} url={result.url}/>


                            );
                        })}
                    </div>
            );


        }
    });
    var Result = React.createClass({

        render: function () {
            return (


                    <a key={this.props.id} href={"https://www.reddit.com" + this.props.url}>
                        <div className="suggestedSub">
                            {this.props.display_name}
                        </div>
                    </a>



            );
        }
    });


    var SearchList = React.createClass({

        render: function () {

            var createItem = this.props.terms.map((term, index) => {

                return (
                        <div key={term.id}>
                            <SearchListItem key={term.id} id={term.id} text={term.text} index={index}
                                            deleteTerm={this.props.deleteTerm.bind(null, term)}/>
                        </div>

                );
            }, this);
            return (
                    <div id="terms">My list of terms:
                        {createItem}
                    </div>

            );


        }

    });


    var SearchListItem = React.createClass({

        render: function () {

            return (
                    <div key={this.props.id} className="termitems">
                        <div className="searchterm termitem">{this.props.text}</div>
                        <button id="deleteterm " onClick={this.props.deleteTerm}>✖</button>
                    </div>
            );
        }
    });


    var TopicBox = React.createClass({
        getInitialState: function () {
            return {
                section: "top",
                id: count++,
                thedata: [{additional: [], ups: 0, permalink: "0", subreddit: "0", title: "0", id: 1}]
            };
        },

        refreshLoadedData: function (section) {

            $.ajax({
                url: "https://www.reddit.com/" + section + "/.json?&limit=25",
                dataType: 'json',
                cache: false,
                success: function (data) {
                    var formatteddata = [];
                    var subs = [];
                    $.each(data.data.children, function (index, element) {
                        var el = {
                            additional: [],
                            id: element.data.id,
                            comments: element.data.num_comments,
                            title: element.data.title,
                            url: element.data.url,
                            permalink: element.data.permalink,
                            ups: element.data.ups,
                            subreddit: element.data.subreddit
                        };
                        //If data comment is from a subreddit that is already sotred, add it to that object instead of creating a new one
                        if (subs.includes(element.data.subreddit)) {
                            formatteddata[subs.indexOf(element.data.subreddit)].additional.push(el);
                        } else {
                            formatteddata.push(el);
                            subs.push(element.data.subreddit);
                        }
                    });
                    formdata = formatteddata;
                    this.setState({thedata: formatteddata, id: count++});
                }.bind(this),
                error: function (xhr, status, err) {
                    console.error(this.props.url, status, err.toString());
                }.bind(this)
            });
        },
        componentDidMount: function () {
            this.refreshLoadedData(this.state.section);
        },

        handleAdd: function (e) {
            e.preventDefault(); // This is, by default, submit button by form. Make sure it isn't submitted.
            this.refreshLoadedData(e.target.value);


            formdata.forEach(function (item) {
                var items = {"name": item.subreddit, "children": []};
                var children = {"size": item.ups, "name": item.title, "url": item.url};
                items.children.push(children);
                if (item.additional.length > 0) {
                    item.additional.forEach(function (child) {
                        var child = {"size": child.ups, "name": child.title, "url": child.url};
                        items.children.push(child);
                    });

                }
                donedata.children.push(items)
                createTreemap();

            });


        },
        render: function () {
            ++count;
            return (

                    <section className="visualizations2" id="visualizations2">
                        <div key={this.props.id} className="TopicBox ">

                            <ul className="tabs text-center">
                                <li>
                                    <button onClick={this.handleAdd} value="top" className="tab">Top</button>
                                </li>
                                <li>
                                    <button onClick={this.handleAdd} value="rising" className="tab">Rising</button>
                                </li>
                                <li>
                                    <button onClick={this.handleAdd} value="new" className="tab">New</button>
                                </li>
                                <li>
                                    <button onClick={this.handleAdd} value="controversial" className="tab">Controversial
                                    </button>
                                </li>
                                <li>
                                    <button onClick={this.handleAdd} value="hot" className="tab">Hot</button>
                                </li>
                            </ul>
                            <div className="container">
                                <div className="row">
                                    <div className="col-sm-12 col-lg-offset-1 col-lg-10">
                                        <h1 className="text-center">Subreddits with popular posts</h1>
                                        <form>
                                            <label><input type="radio" name="mode" value="size" defaultChecked/>
                                                Size</label>
                                            <label><input type="radio" name="mode" value="count"/> Count</label>
                                        </form>
                                        <div id="graf" className="graf"></div>
                                        <TopicList id={count} data={this.state.thedata}/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

            );
        }
    });


    var TopicList = React.createClass({
        render: function () {
            ++count;
            if (this.props.data != undefined) {

                var commmentNodes = this.props.data.map(function (comment) {
                    if (comment.additional.length > 0) {
                        var morecommmentNodes = comment.additional.map(function (mcomment) {
                            return (
                                    <Comment key={mcomment.id} comments={mcomment.comments} url={mcomment.url}
                                             moresubs={mcomment.additional} permalink={mcomment.permalink}
                                             ups={mcomment.ups}>
                                        {mcomment.title}
                                    </Comment>
                            );
                        });
                    }

                    return (
                            <div key={count++} className="cList">
                                <div className="col-sm-12 subredditTitle">
                                    <a href={'https://www.reddit.com/r/' + comment.subreddit + "/"}>
                                        <div className="cSubName">{comment.subreddit}
                                        </div>
                                    </a>
                                </div>
                                <Comment key={comment.id} comments={comment.comments} url={comment.url}
                                         moresubs={comment.additional} permalink={comment.permalink} ups={comment.ups}>
                                    {comment.title}
                                </Comment>
                                {morecommmentNodes}


                            </div>
                    );

                });


            }
            return (

                    <div key={this.props.id} className="commentSubreddit ">
                        {commmentNodes}

                    </div>
            );
        }
    });


    // tutorial4.js
    var Comment = React.createClass({
        render: function () {
            return (
                    <div key={this.props.id} className=" col-lg-12 col-sm-12 cSubreddit">
                        <div className="col-sm-2 col-lg-1 row-no-padding">

                            <div className="ups"><i className="fa fa-thumbs-up"
                                                    aria-hidden="true"></i> {" " + this.props.ups}
                            </div>
                        </div>
                        <div className="col-sm-8 col-lg-10 ">
                            <div className="cTitle"><a href={this.props.url}>
                                {this.props.children}
                            </a>
                            </div>
                        </div>
                        <div className="col-sm-2 col-lg-1 row-no-padding">
                            <div className="cComNum"><a
                                    href={'https://www.reddit.com' + this.props.permalink}><i
                                    className="fa fa-comment-o"
                                    aria-hidden="true"></i> {" " + this.props.comments}
                            </a></div>
                        </div>


                    </div>

            );
        }
    });


    //ReactDOM.render(
    //        <LandingPage />
    //
    //        ,
    //        document.getElementById('mainpage')
    //);


    function createTreemap() {


        var margin = {top: 40, right: 10, bottom: 10, left: 10},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

        var color = d3.scale.category20c();

        var treemap = d3.layout.treemap()
                .size([width, height])
                .sticky(true)
                .value(function (d) {
                    return d.size;
                });
        document.getElementById("graf").innerHTML = "";
        var div = d3.select("div.graf").append("div")
                .style("position", "relative")
                .style("width", (width + margin.left + margin.right) + "px")
                .style("height", (height + margin.top + margin.bottom) + "px")
                .style("left", margin.left + "px")
                .style("top", margin.top + "px");

        var root = donedata;


        var node = div.datum(root).selectAll(".node")
                .data(treemap.nodes)
                .enter()
                .append("div")
                .attr("class", "node")
                .call(position)
                .style("background", function (d) {
                    return d.children ? color(d.name) : null;
                })
                .text(function (d) {
                    return d.children ? null : d.name;
                });


        d3.selectAll("input").on("change", function change() {
            var value = this.value === "count"
                    ? function () {
                return 1;
            }
                    : function (d) {
                return d.size;
            };

            node
                    .data(treemap.value(value).nodes)
                    .transition()
                    .duration(1500)
                    .call(position);
        });


        function position() {
            this.style("left", function (d) {
                return d.x + "px";
            })
                    .style("top", function (d) {
                        return d.y + "px";
                    })
                    .style("width", function (d) {
                        return Math.max(0, d.dx - 1) + "px";
                    })
                    .style("height", function (d) {
                        return Math.max(0, d.dy - 1) + "px";
                    });
        }

    }


    function createCirclemap() {


        var diameter = 960,
                format = d3.format(",d"),
                color = d3.scale.category20c();

        var bubble = d3.layout.pack()
                .sort(null)
                .size([diameter, diameter])
                .padding(1.5);
        document.getElementById("circle").innerHTML = "";
        var svg = d3.select("#circle").append("svg")
                .attr("width", diameter)
                .attr("height", diameter)
                .attr("class", "bubble");

        var root = circledata;


        var node = svg.selectAll(".node")
                .data(bubble.nodes(classes(root))
                        .filter(function (d) {
                            return !d.children;
                        }))
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) {
                    return "translate(" + d.x + "," + d.y + ")";
                });

        node.append("title")
                .text(function (d) {
                    return d.className + ": " + format(d.value);
                });


        node.append("svg:a")
                .attr("xlink:href", function (d) {
                    return "https://www.reddit.com/r/" + d.className + "/";
                })
                .append("circle")
                .attr("r", function (d) {
                    return d.r;
                })
                .style("fill", function (d) {
                    return color(d.packageName);
                })
                .attr("x", 100)
                .attr("y", 50)
                .attr("height", 100)
                .attr("width", 200)
                .style("fill", "lightgreen")

                .attr("rx", 10)
                .attr("ry", 10);

        node.append("svg:a")
                .attr("xlink:href", function (d) {
                    return "https://www.reddit.com/r/" + d.className + "/";
                })
                .append("text")
                .attr("dy", ".3em")
                .style("text-anchor", "middle")
                .text(function (d) {
                    return d.className.substring(0, d.r / 3);
                })


// Returns a flattened hierarchy containing all leaf nodes under the root.
        function classes(root) {
            var classes = [];

            function recurse(name, node) {
                if (node.children) node.children.forEach(function (child) {
                    recurse(node.name, child);
                });
                else classes.push({packageName: name, className: node.name, value: node.size});
            }

            recurse(null, root);
            return {children: classes};
        }

        d3.select(self.frameElement).style("height", diameter + "px");
    }
    ReactDOM.render(
            <LandingPage />

            ,
            document.getElementById('mainpage')
    );

    describe('TopicBox', function(){
        var TestUtils = React.addons.TestUtils;
        var TopicBoxComponent, element, renderedDOM;
        beforeEach(function (done){
            element = React.createElement(TopicBox);
            TopicBoxComponent = TestUtils.renderIntoDocument(element);
            TopicBoxComponent.setState({section: "top",  thedata: [{additional: [], ups: 0, permalink: "0", subreddit: "0", title: "0", id: 1}]}, done);
        });
        it("Has 5 buttons: Top, Rising, New, Controversial, Hot ", function(){
            let buttons = TestUtils.scryRenderedDOMComponentsWithTag(TopicBox, "button");
            expect(buttons.length).toEqual(5);
            expect(buttons[0]).not.toBeUndefined();
            expect(buttons[0].innerHTML).toBe("Top");
            expect(buttons[1]).not.toBeUndefined();
            expect(buttons[1].innerHTML).toBe("Rising");
            expect(buttons[2]).not.toBeUndefined();
            expect(buttons[2].innerHTML).toBe("New");
            expect(buttons[3]).not.toBeUndefined();
            expect(buttons[3].innerHTML).toBe("Controversial");
            expect(buttons[4]).not.toBeUndefined();
            expect(buttons[5].innerHTML).toBe("Hot");
        });

    });
    describe("SearchBox", function () {
        var TestUtils = React.addons.TestUtils;
        var SearchBoxComponent, element, renderedDOM;
        beforeEach(function (done) {
            element = React.createElement(SearchBox);
            SearchBoxComponent = TestUtils.renderIntoDocument(element);
            SearchBoxComponent.setState({results: [], text: "", id: ++count, terms: []}, done);
        });
        it("Has 2 buttons: Connect with Facebook, Search for Subreddits", function () {
            let buttons = TestUtils.scryRenderedDOMComponentsWithTag(SearchBoxComponent, "button");
            expect(buttons.length).toEqual(2);
            expect(buttons[0]).not.toBeUndefined();
            expect(buttons[0].innerHTML).toBe("Connect with Facebook");
            expect(buttons[1]).not.toBeUndefined();
            expect(buttons[1].innerHTML).toBe("Search for Subreddits");
        });
        it("Has a Search List component", function () {
            expect(function () {
                TestUtils.findRenderedComponentWithType(SearchBoxComponent, SearchList);
            }).not.toThrow();
        });
        it("Has a Result List component", function () {
            expect(function () {
                TestUtils.findRenderedComponentWithType(SearchBoxComponent, ResultList);
            }).not.toThrow();
        });

        describe('TopicBox', function(){
            var TestUtils = React.addons.TestUtils;
            var TopicBoxComponent, element, renderedDOM;
            beforeEach(function (done){
                element = React.createElement(TopicBox);
                TopicBoxComponent = TestUtils.renderIntoDocument(element);
                TopicBoxComponent.setState({section: "top",  thedata: [{additional: [], ups: 0, permalink: "0", subreddit: "0", title: "0", id: 1}]}, done);
            });
            it("Has a TopicList component", function(){
                expect(function () {
                    TestUtils.findRenderedComponentWithType(TopicBoxComponent, TopicList);
                }).not.toThrow();

            });

        });


    });

=======
>>>>>>> gh-pages


</script>
<style>
    form {
        position: absolute;
        right: 10px;
        top: 10px;
    }

    .node {
        border: solid 1px white;
        font: 10px sans-serif;
        line-height: 12px;
        overflow: hidden;
        position: absolute;
        text-indent: 2px;
    }

</style>


</body>
</html>
